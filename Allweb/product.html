{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %}สินค้า | Tumweb{% endblock %}
{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=BBH+Sans+Bogle&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/product.css' %}">
<link rel="stylesheet" href="{% static 'css/spec.css' %}">
{% endblock %}

{% block content %}
<header class="product-h">
  <h1 class="h-tt">PRODUCT</h1>
</header>
<div class="spec">
<button type="button" class="b-spec" onclick="toggleSpec()">เลือกการใช้งานเครนพับ
<span class="subspec-caret" aria-label="เปิดเมนูย่อย: เลือกการใช้งานเครนพับ"></span>
</button>
  <!-- แผงฟอร์มเลือกสเปค (พับได้) -->
  <form id="specForm"
        class="spec-panel {% if selected_vehicles or selected_usages %}open{% endif %}"
        method="get">

    <!-- ขนาดรถที่รองรับ -->
    <fieldset class="spec-group">
      <legend class="topic-spec">ขนาดรถที่รองรับ:</legend>
      <div class="options">
        {% for code, label in vehicle_choices %}
          <label class="opt">
            <input type="checkbox" name="vehicle" value="{{ code }}"
                   {% if code in selected_vehicles %}checked{% endif %}>
            <span>{{ label }}</span>
          </label>
        {% empty %}
          <p class="muted">ยังไม่มีข้อมูลขนาดรถ</p>
        {% endfor %}
      </div>
    </fieldset>

    <!-- การใช้งาน -->
    <fieldset class="spec-group">
      <legend class="topic-spec">การใช้งาน:</legend>
      <div class="options">
        {% for u in usages %}
          <label class="opt">
            <input type="checkbox" name="usage" value="{{ u.id }}"
            {% if u.name == "ที่นั่งควบคุมบนสำหรับคีบเหล็ก" %} data-key="seat-top"{% endif %}
            {% if u.id in selected_usages %}checked{% endif %}>
            <span>{{ u.name }}</span>
          </label>
        {% empty %}
          <p class="muted">ยังไม่มีข้อมูลการใช้งาน</p>
        {% endfor %}
      </div>
    </fieldset>
    <fieldset class="top-group">
      <legend class="topic-spec">หมายเหตุ:</legend>
      <p class="message">1. <span class="sub-topic" style="color: rgb(224, 39, 39)">อุปกรณ์ต่อพ่วง</span> - กรณีต้องการเครนรายการอื่นๆและเดินท่อปลายเครนเพิ่ม สามารถติดต่อสอบถามเพิ่มเติม </p> 
      <p class="message">2. <span class="sub-topic"style="color: rgb(224, 39, 39)">ทำที่นั่งควบคุมบนสำหรับติดตัวคีบเหล็ก</span> - กรณีต้องการเครนรายการอื่นๆและทำที่นั่งควบคุมบนเพิ่ม สามารถติดต่อสอบถามเพิ่มเติม</p> 
    </fieldset>
    <!-- ตัวกรองที่เลือก (ชิป) -->
    <div class="spec-selected">
      <span class="selected">ตัวกรองที่เลือก:</span>
      {% if not selected_vehicles and not selected_usages %}
        <span class="muted" id="muted"> - </span>
      {% endif %}

      {# แสดง label ของ vehicle ที่เลือก โดยหา label จาก vehicle_choices #}
      {% for v in selected_vehicles %}
        {% for code,label in vehicle_choices %}{% if code == v %}
          <span class="chip">{{ label }}</span>
        {% endif %}{% endfor %}
      {% endfor %}

      {% for u in usages %}
        {% if u.id in selected_usages %}
          <span class="chip">{{ u.name }}</span>
        {% endif %}
      {% endfor %}
    </div>
    

    <div class="spec-actions">
      <button type="submit" class="btn-ok">ตกลง</button>
      <button type="button" id="btnClear" class="btn-clear">ล้าง</button>
    </div>
  </form>
</div>
<!-- ===== ผลลัพธ์สินค้า ===== -->
  {% if has_filters %}
  <section id="results" class="results">
    <h2 class="topic-results">ผลลัพธ์สินค้า</h2>
    <div class="product-grid">
      {% for p in products %}
        <a class="product-card" href="{% url 'product_detail' p.id %}">
          {% if p.image %}<img src="{{ p.image.url }}" alt="{{ p.name }}">{% endif %}
          <h3 class="name">{{ p.name }}</h3>
          <p class="brand">{{ p.brand }}</p>
          <div class="price-box">
            {% if p.price %}
            <p class="price">฿ {{ p.price }}</p>
            {% else %}
            <div class="noprice"></div>
            {% endif %}
          </div>
           {% if p.description %}<p class="desc">{{ p.description|truncatechars:25 }}</p>{% endif %} 
          <span class="more">ดูรายละเอียด</span>
        </a>
      {% empty %}
        <p class="muted">ไม่พบสินค้าตามตัวกรอง</p>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  {% for category in sections %}
    <section class="category-section" id="cat-{{ category.id }}">
      <h2 class="ctgr-tt">{{ category.name }}</h2>

 {# สินค้าที่อยู่ในหมวดหลักโดยตรง #}
    {% with direct_products=category.products_direct.all %}
      {% if direct_products %}
        <div class="product-grid">
          {% for p in direct_products %}
            <a class="product-card" href="{% url 'product_detail' p.id %}">
              {% if p.image %}<img src="{{ p.image.url }}" alt="{{ p.name }}">{% endif %}
              <h4 class="name">{{ p.name }}</h4>
              <p class="brand">รุ่น {{ p.brand }}</p>
              <div class="price-box">
                {% if p.price %}
                <p class="price">฿ {{ p.price }}</p>
                {% else %}
                <div class="noprice"></div>
                {% endif %}
              </div>
               {% if p.description %}<p class="desc">{{ p.description|truncatechars:25 }}</p>{% endif %} 
              <span class="more">ดูรายละเอียด</span>
            </a>
          {% endfor %}
          {% else %}
          {% if category.id != 3 %}
          <div class="nocategory-c">
            <p class="empty">ไม่มีสินค้าในหมวดนี้</p>
          {% endif %}
          </div>
          {% endif %}
        </div>
    {% endwith %}

    {# หมวดย่อย (เช่น แบรนด์) #}
    {% for sub in category.subcategories.all %}
      <h3 id="sub-{{ sub.id }}" class="subctgr-tt">{{ sub.name }}</h3>
      <div class="product-grid">
        {% for p in sub.products.all %}
          <a class="product-card" href="{% url 'product_detail' p.id %}">
            {% if p.image %}<img src="{{ p.image.url }}" alt="{{ p.name }}">{% endif %}
            <h4 class="name">{{ p.name }}</h4>
            <p class="brand">รุ่น {{ p.brand }}</p>
            <div class="price-box">
            {% if p.price %}
              <p class="price">฿ {{ p.price }}</p>
            {% else %}
            <div class="noprice"></div>
            {% endif %}
            </div>
            {% if p.description %}<p class="desc">{{ p.description|truncatechars:25 }}</p>{% endif %}
            <span class="more">ดูรายละเอียด</span>
          </a>
        {% empty %}
          <p class="empty">ไม่มีสินค้าในหมวดย่อยนี้</p>
        {% endfor %}
      </div>
    {% endfor %}
  </section>
{% empty %}
  <section class="category-section">
    <h2 class="category-title">ยังไม่มีสินค้า</h2>
    <p style="margin-left:60px;">กรุณาเพิ่มสินค้าจากหลังบ้าน (Admin)</p>
  </section>
{% endfor %}
<script>
function resetFilters() {
  const f = document.getElementById('specForm');
  if (f) f.reset();  
  document.querySelectorAll('input[type="checkbox"]').forEach(u=>{  // ล้าง checkbox
    u.checked = false;
  });       
  document.querySelectorAll('input[name="usage"]').forEach(u=>{
    u.disabled = true;                                   // ล็อก usage กลับ (ต้องเลือกขนาดรถก่อน)
    u.closest('label')?.classList.add('is-disabled');
  });
  const r = document.getElementById('results');          // ซ่อนผลลัพธ์
  if (r) r.style.display = 'none';
  history.replaceState({}, '', location.pathname);       // ล้าง ?vehicle=&usage= ออกจาก URL
  const box = document.querySelector('.spec-selected');
  if (box) box.innerHTML = '<span class="selected">ตัวกรองที่เลือก:</span> <span class="muted" id="muted">-</span>';
}

// ผูกปุ่มล้างตัวกรองให้เรียก reset แบบ "คง panel เปิด"
document.getElementById('btnClear')?.addEventListener('click', (e) => {
  e.preventDefault();
  resetFilters(true);
});
function toggleSpec(){
  const p = document.getElementById('specForm');        // ตัวพาแนล
  const c = document.querySelector('.subspec-caret');    // ลูกศร (ถ้ามี)
  if (!p) return;
  const isOpen = p.classList.contains('open');

  if (isOpen) {                                          // ปิด = รีทุกอย่างในแผง
    resetFilters();
    p.style.maxHeight = '0px';
    p.classList.remove('open');
    p.style.display = 'none';
    c?.classList.remove('open');
  } else {                                               // เปิด = กางแผง
    p.style.display = 'block';
    p.style.maxHeight = p.scrollHeight + 'px';
    p.classList.add('open');
    c?.classList.add('open');
  }
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const FORBID = new Set(['4B','6S']);
  const vehicles = [...document.querySelectorAll('input[name="vehicle"]')];
  const usages   = [...document.querySelectorAll('input[name="usage"]')];
  const seatTop  = document.querySelector('input[name="usage"][data-key="seat-top"]');

  const anyVehiclePicked = () => vehicles.some(v => v.checked);
  const hasForbiddenVeh  = () => vehicles.some(v => v.checked && FORBID.has(v.value));

  function applyRules() {
    const pickedAny = anyVehiclePicked();
    usages.forEach(u => {
      if (!pickedAny) {
        u.checked = false;
        u.disabled = true;
        u.closest('label')?.classList.add('is-disabled');
        u.title = 'กรุณาเลือกขนาดรถก่อน';
      } else {
        u.disabled = false;
        u.closest('label')?.classList.remove('is-disabled');
        u.title = '';
      }
    });

    if (seatTop) {
      if (pickedAny && hasForbiddenVeh()) {
        seatTop.checked = false;
        seatTop.disabled = true;
        seatTop.closest('label')?.classList.add('is-disabled');
        seatTop.title = 'ใช้ไม่ได้กับ 4ล้อใหญ่ หรือ 6ล้อเล็ก';
      } else if (pickedAny) {
        seatTop.disabled = false;
        seatTop.closest('label')?.classList.remove('is-disabled');
        seatTop.title = '';
      }
    }
  }

  vehicles.forEach(v => v.addEventListener('change', e => {
    if (e.target.checked) {
      // ปิดและจางตัวอื่นในกลุ่ม vehicle
      vehicles.forEach(x => {
        if (x !== e.target) {
          x.checked = false;
          x.disabled = true;
          x.closest('label')?.classList.add('is-disabled');
        }
      });
    } else {
      // ถ้ายกเลิก ให้เปิดทั้งหมดคืน
      vehicles.forEach(x => {
        x.disabled = false;
        x.closest('label')?.classList.remove('is-disabled');
      });
    }
    applyRules();
  })
);
  usages.forEach(u => u.addEventListener('change', e => {
      if (e.target.checked) {
      // ปิดและจางตัวอื่นในกลุ่ม usage
      usages.forEach(x => {
        if (x !== e.target) {
          x.checked = false;
          x.disabled = true;
          x.closest('label')?.classList.add('is-disabled');
        }
      });
    } else {
      // ถ้ายกเลิก ให้เปิดทั้งหมดคืน
      usages.forEach(x => {
        x.disabled = false;
        x.closest('label')?.classList.remove('is-disabled');
      });
    }
    if (!anyVehiclePicked()) e.target.checked = false;
    if (e.target === seatTop && hasForbiddenVeh()) {
      e.target.checked = false;
      e.target.disabled = true;
      seatTop.closest('label')?.classList.add('is-disabled');
    }
  }));
  applyRules();
});
</script>
<script>
// สมมติแผงเลือกสเปคครอบด้วย id="specPanel"
const panel = document.getElementById('specPanel');

// เพิ่ม listener รวม เพื่อบังคับให้เลือกได้ทีละ 1 ในแต่ละกลุ่ม
panel?.addEventListener('change', (e) => {
  const t = e.target;
  // รับเฉพาะ checkbox สองกลุ่มนี้เท่านั้น
  if (!t.matches('input[type="checkbox"][name="vehicle"], input[type="checkbox"][name="usage"]')) return;
  // ถ้าติ๊ก -> ปลดติ๊กตัวอื่นในกลุ่มเดียวกัน (vehicle หรือ usage)
  if (t.checked) {
    panel.querySelectorAll(`input[name="${t.name}"]`).forEach(el => {
      if (el !== t) el.checked = false;
    });
  }
  // ปล่อยให้(applyRules, เงื่อนไข seatTop) ทำงานต่อไป
});
</script>
<script>
  // กดปุ่มตกลงแล้วเลือนไปหาผลลัพธ์
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('specForm');
  if (!form) return;

  form.addEventListener('submit', () => {
    
    const url = new URL(window.location.href);
    form.action = url.pathname + '#results';
  });
});
</script>

<style>
  .opt.is-disabled { opacity:.5; pointer-events:none; }
</style>

    <div class="endweb" style=" overflow: hidden; width: 100%; height: 420px; background:black;">
        <div class="contactend">
        <img src="{% static 'images/logomaccrane1.png' %}" alt="โลโก้เครน" class="logocrane2-img">
        <h3 class="contact-ttend">บริษัท แม็ค โปรเมททอล จำกัด</h3>
        <ul class="contact-listend">
            <li>
              <a href="https://maps.google.com/maps/place//data=!4m2!3m1!1s0x311d81059e8b0267:0xc7e8169525d50858?entry=s&sa=X&ved=2ahUKEwjBmL3X98mQAxUlavUHHRpOATgQ4kB6BAgXEAA" target="_blank" rel="noopener">10/28 ม.13 ต.คลองหนึ่ง อ.คลองหลวง จ.ปทุมธานี 12120</a>
            </li>
            <li>
            <div class="facebook-end">
              <a class="fb-end" href="https://www.facebook.com/Maccranes" target="_blank" rel="noopener noreferrer" aria-label="Facebook Page">
               <!-- Facebook SVG -->
                <svg class="logofb" viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
                  <path d="M22 12a10 10 0 1 0-11.6 9.9v-7h-2.2V12h2.2V9.8c0-2.2 1.3-3.4 3.2-3.4.9 0 1.8.16 1.8.16v2h-1c-1 0-1.3.62-1.3 1.26V12h2.2l-.35 2.9h-1.85v7A10 10 0 0 0 22 12z"/>
                </svg> <span>Facebook</span></a>
              </li>

            <li class="gt">
             <span>Email:</span><a href="mailto:mac.cranetrucks@gmail.com"> mac.cranetrucks@gmail.com</a>
            </li>
            <li class="gt">
             <span>Tel/Line/WhatsApp:</span> <a href="tel:0827963619">082-796-3619</a>
            </li>
            <li class="oe">เปิด 8:00น.–17:00น. จันทร์-ศุกร์</li>
        </div>
    </div>
    <div style="height: auto; background:#c2bdbd;"></div>
{% endblock %}
